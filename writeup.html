<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
  <head>
    <meta http-equiv="content-type" content="text/html;
      charset=windows-1252">
    <title>writeup</title>
    <meta name="changed" content="2020-09-26T12:17:55.891000000">
  </head>
  <body dir="ltr" link="#000080" lang="en-US" vlink="#800000">
    <h1 class="western"> Mailbox notifier tweaks...</h1>
    <p>I built the notifier for a friend and it all works as its
      supposed to but during testing I noticed some possible
      improvements so tweaked a bit to see how it went. The results were
      a bit surprising so I'll outline them here.<br>
      The WiFi related connect times will vary depending on your WiFi
      environment and router make/model. The times I describe are on my
      home system. Yours might be quite different.</p>
    <p>I read through the project documentation and the
      self-bootstrapped option seemed like a logical way to save power.
      When its off, NO power consumption, zilch, nada!<br>
      Well, you cant get much better than that (obviously). So I tried
      both deep-sleep and self bootstrap and did some comparisons. </p>
    <h3 class="western">Deep-sleep first.</h3>
    <p>The aim is to run this gadget on batteries. The problem is, that
      when running its a power-hungry beast! So reducing power
      consumption is our first goal.</p>
    <p>Where does the power go?<br>
      The project choice of ESP board was not a good one. The Wemos
      mini-board has power overheads. It has an on-board regulator and a
      USB&gt;serial chip. Both of these contribute substantially to the
      'background' power consumption and cant be disabled. <br>
      The actual ESP module (inside the metal can) can be set to a very
      low power standby mode, typically about 20uA, sometimes a bit
      less. However, the USB to serial interface and regulator consume
      about 6mA which is huge in proportion to the ESP module in
      deep-sleep. If using this ESP-mini board (XC3802) then perhaps the
      self-bootstrap method is worth it. </p>
    <p>However, by choosing a different ESP board (an ESP-01) this will
      straight-away improve your power savings. Its cheaper too, but not
      as simple to program as the WeMos board.<br>
      The ESP-01 is a very basic module. No USB serial interface chip,
      no regulator. It does have a power LED but this is simple to
      remove with a soldering iron or razor-blade. Do remove it! It eats
      power when permanently lit.<br>
      When the ESP-01 goes into deep-sleep, its now as good as it can
      get.<br>
    </p>
    <h3>To the software...</h3>
    <p>In the original sketch, the time taken from the reset being
      triggered to the end of the WiFi transaction to IFTTT is around
      7~8 seconds. Sometimes a bit more, sometimes a bit less, but
      that's in the ball-park.</p>
    <p>There are two time-consuming items at work here, and time
      directly relates to power consumption.<br>
      <b>1:</b> WiFi connect is very slow<br>
      <b>2:</b> HTTPS is being used.</p>
    <p><b>1:)</b><br>
      WiFi connect time can be substantially improved by an optimized
      connection method. I used the method outlined at:<br>
      https://pokewithastick.net/esp8266-fast-wifi-connect-post</p>
    <p>My times were actually a bit better than the authors as I used: <br>
      ESP.deepSleep(0, WAKE_NO_RFCAL); instead of the basic&nbsp;
      ESP.deepSleep(0);<br>
      This knocks about 20ms off your startup time.<br>
      Even better is to use ESP.deepSleepInstant(0, WAKE_NO_RFCAL)<br>
      This improves the shut-down time by about 100ms.<br>
      These numbers don't sound very significant but it all adds up to
      reduced power usage.</p>
    <p>Using the fast connect method described at pokewithastick.net, I
      had a fully connected usable WiFi by 192~204 ms (by millis()
      timestamps). This was a lot faster than I ever thought possible.
      If your using this method to do UDP posts, you could be all-done
      by 210ms!<br>
      <br>
      <b>2:)</b><br>
      HTTPS is used for the connection to IFTTT. It is a <b>requirement</b>
      of their service. </p>
    <p>On an ESP8266, HTTPS is slow. Its unavoidable due to limitations
      within the ESP chip as it has no dedicated hardware to deal with
      the encryption/decryption so the number-crunching is all done in
      software, not hardware.</p>
    <p>HTTP does work and is OK to use during testing and development
      but production products must use HTTPS.</p>
    <p>Using the fast WiFi connect method and HTTPS, the time taken from
      the start of the reset trigger (to wake up the ESP) till the
      network transaction to IFTTT is complete, this time gets reduced
      to about 3.2~3.5 sec. This running time is at least halved from
      the 7~8 sec at the start, so the battery life just doubled!<br>
      When using HTTP during testing phase this time drops to
      900ms~1.1sec. The overhead of HTTPS is severe but unavoidable.</p>
    <p><b>Please note:<br>
      </b>If you use an ESP-01 It has NO REGULATOR so only power from
      2xAA batteries (or C\D cells). The ESP will work down to about
      2.5V. Then put the batteries in something else (torch, TV
      remote...)<br>
      Two brand-spankin' new/fresh batteries will be around 3.2V</p>
    <p>The ESP can also be configured to read its own VCC, no external
      components required. The ESP-01 has no external pin for the ADC
      but reading its internal VCC works just fine.<br>
      This means you can report the battery state as part of the
      notification message sent to IFTTT so you know when to change the
      batteries.</p>
    <h2 class="western">Now the self-bootstrap method</h2>
    <p>It seems logical and bound to be a winner but it comes down to
      startup time and frequency of activity.</p>
    <p>Using the fastest possible WiFi connect, the connect time from <b>deep-sleep</b>
      as outlined above, is about 200ms.<br>
      If instead of exiting deep sleep, you connect from a power-up
      condition, this takes about 1.2 sec longer for the WiFi to
      connect.<br>
      This extra 1.2 sec running time eats into the power you saved by
      doing a full power-down.<br>
      On exit from deep-sleep, there is an on-chip record maintained in
      the RTC ram with some details of the WiFi connection so they don't
      have to be discovered again. The chip knows if it was reset or
      powered on, so on startup behaves slightly differently for each
      case. <br>
      If powered on, the internal chip volatile memory has been cleared
      so the WiFi connect time is just a little bit slower. </p>
    <p>Some numbers...<br>
      Lets take deep-sleep as 20uA and the ESP running with WiFi-on at
      an average70mA</p>
    <p>24 hrs of deep sleep consumes 24 x 20uA = 0.48mA/hrs<br>
      1-sec is 1/3600 of an hour<br>
      1-sec of ESP running = (1/3600) * 70mA = 0.0194 mA/hr</p>
    <p>3.5 sec (HTTPS) = 0.0679mA/hr</p>
    <p>So for two activation's a day, the mailbox power consumption is:
      0.1358 mA/hr + deep-sleep (0.48) = 0.6158mA/hr in 24-hrs</p>
    <p>Now consider powering-on instead of using deep-sleep.<br>
      WiFi takes about 1.2-sec longer to connect so active power for
      twice a day becomes 4.7sec x 2 x 0.0194mA/hr = 0.1823mA/hr which
      is much better than the deep-sleep method. <br>
      For occasional use, the power-on method wins. As the frequency of
      use per day increases, the savings gained from a full power-off
      get less and less because of the extra 1.2 sec added to the
      connect time, so do your sums and work out what is best for your
      application. You may be better off using deep-sleep.</p>
    <p>24-hrs of deep-sleep (0.48mA/hr) is 24.7 seconds of ESP running
      time (at 70mA).</p>
    <p>Of course, its not quite that straightforward. It depends what
      the ESP is doing, but as a guide, its useful.</p>
    <h3 class="western">Things to consider</h3>
    <ul>
      <li>
        <p>Under load, the battery voltage instantaneously drops due to
          the internal resistance of the battery. During high current
          spikes this may trigger the ESP's low-voltage brownout
          detection. <br>
          The ESP-01 <b>will</b> need an electrolytic cap (at least
          100uF) across the ESP power pins so that should help to a
          certain degree.<br>
          I have wondered about using a supercap in parallel with the
          battery.<br>
          This will certainly increase the leakage current but it will
          also be able to supply most, if not all of the high-current
          peaks and so hold the battery above the brownout trigger
          threshold. It may allow the system to use the same battery for
          longer, even with the higher leakage. I have not tried this
          yet. I don't have any supercaps and no data on leakage either
          but I'll add it to my long list of stuff to look up :)</p>
      </li>
    </ul>
    <ul>
      <li>
        <p>The connect times above are from when millis() starts, which
          is <b>before</b> the user sketch starts running.<br>
          If rf-cal is enabled, millis() is about 65 at the start of a
          sketch. If rf-cal is disabled, millis() is about 43.<br>
          From triggering reset (exit from deep-sleep) to the start of
          the sketch is about 120ms (no rf-cal). In this time, the chip
          initializes and the WiFi connection is started in the
          background (using the optimized connection method as above) <br>
          WiFi may not actually be connected by the start of the sketch
          but its under-way and impressively fast.</p>
      </li>
      <li>
        <p style="margin-bottom: 0in; line-height: 100%">A method of
          self-bootstrap is described and shown at: <a
            href="https://www.youtube.com/watch?v=n_A_8Y4xNx8"><b>https://www.youtube.com/watch?v=n_A_8Y4xNx8</b></a><br>
          This does not require a FET to do the switching but instead
          uses the PD pin (power-down) or sometimes called CE (chip
          enable).<br>
          Power is always connected to the ESP but consumption is in the
          order of 2~3 uA when shut down. This level of standby power
          consumption over 24-hrs equates to about 3.7 sec of 70mA
          run-time.</p>
      </li>
      <li>
        <p style="margin-bottom: 0in; line-height: 100%">When dealing
          with these very low currents, its difficult to get accurate
          readings with a multi-meter as the multi-meter itself adds a
          burden to the circuit being measured. It is worth reading <a
href="http://alternatezone.com/electronics/ucurrent/uCurrentArticle.pdf">THIS</a>
          article to get a better understanding of why it is a problem,
          even with very expensive meters.<br>
          Even simplest of circuits often have sources of leakage. A
          simple electrolytic capacitor across the power rails has
          leakage. A FET in its off state also has leakage. How far do
          you go in the pursuit of low-power? <br>
          A randomly selected capacitor data sheet (470uF/6.3V) quoted:
          <b>DC Leakage Current I &lt;</b><b>=</b><b> 0.01 CV or 3 (&#956;A)
            After 2 minutes (Whichever is greater)</b><br>
          So don't go overboard with it. Mostly you can aim for
          good-enough. If it means you have to swap out the batteries
          1-week early after 6-months, its not the end of the world.<br>
          Getting 6-months battery life instead of 3 <i>is</i> worth
          doing but after that? Well, how much time do you have.…<br>
        </p>
      </li>
    </ul>
    Happy tinkering.<br>
    <br>
    <ul>
    </ul>
  </body>
</html>
